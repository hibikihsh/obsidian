---
category:
  - lifull-kaigo
---
# src/Kaigo配下のBundle構造と役割

## Bundleとは？

**Bundle**はSymfonyフレームワークにおける「機能のまとまり」です。Controller、Entity、Services、Viewsなどを1つのパッケージとして管理する単位で、アプリケーションを機能ごとに分割して整理するための仕組みです。

### Bundleの標準構造

```
ExampleBundle/
├── Controller/             # リクエスト処理
├── Entity/                 # DBテーブル定義
├── Repository/             # DB問い合わせ
├── Services/               # ビジネスロジック
├── Form/                   # フォーム定義
├── Resources/
│   ├── config/             # 設定ファイル
│   └── views/              # Twigテンプレート
├── DependencyInjection/    # DIコンテナ設定
└── ExampleBundle.php       # Bundle定義
```

---

## src/Kaigo配下の各Bundle

### 1. **DomainBundle** - ビジネスロジックとデータモデルの中核

**役割**: アプリケーション全体の基盤となるドメイン層

```
DomainBundle/
├── Entity/                 # 全DBテーブル定義（100以上）
│   ├── KaigoFacility.php
│   ├── KaigoCompany.php
│   ├── KaigoInquire.php
│   └── ...
├── Component/
│   ├── Manager/            # ビジネスロジック
│   ├── Repository/         # データアクセス層
│   ├── Relation/           # Entity間の関連処理
│   └── Service/            # 共通サービス
├── Model/                  # ドメインモデル
│   ├── Facility/
│   ├── Inquire/
│   ├── Article/
│   └── ...
├── Util/                   # ユーティリティ
│   ├── PdfUtil.php
│   ├── CsvUtil.php
│   ├── EsQueryBuilder.php
│   └── ...
└── Services/               # 外部連携
    ├── Aws/
    ├── Google/
    └── Mailer.php
```

**特徴**:
- 全Bundleから参照される基盤層
- データベースとの直接的なやり取りを担当
- ビジネスルールの実装

---

### 2. **FrontBundle** - ユーザー向けフロントエンド

**役割**: 一般ユーザーが利用する画面の処理

```
FrontBundle/
├── Controller/
│   ├── DetailFacilityController.php      # 施設詳細
│   ├── ListFacilityAreaController.php    # 施設一覧（エリア）
│   ├── SearchFacilityController.php      # 施設検索
│   ├── ArticleCmsController.php          # 記事CMS
│   ├── InquireFacilityController.php     # お問い合わせ
│   └── ...
├── Services/
│   ├── BusinessLogic/      # ビジネスロジック
│   ├── Tdk/                # SEO（Title/Description/Keywords）
│   ├── CrumbList/          # パンくずリスト
│   ├── Schema/             # 構造化データ
│   └── ...
├── TdkProcessor/           # ページごとのSEO設定
├── CrumbListProcessor/     # ページごとのパンくず設定
└── DataLayerProcessor/     # Google Analytics設定
```

**主な機能**:
- 施設詳細ページ表示
- 施設検索・一覧表示
- 記事コンテンツ表示
- お問い合わせフォーム
- SEO対策（TDK、構造化データ）

---

### 3. **PcFrontBundle / SpFrontBundle** - デバイス別View層

**役割**: デバイスごとのテンプレート管理

```
PcFrontBundle/
└── Resources/
    └── views/              # PC用Twigテンプレート
        ├── DetailFacility/
        ├── ListFacility/
        └── ...

SpFrontBundle/
└── Resources/
    └── views/              # スマホ用Twigテンプレート
        ├── DetailFacility/
        ├── ListFacility/
        └── ...
```

**特徴**:
- FrontBundleのControllerから呼び出される
- デバイスに最適化されたHTML構造
- レスポンシブではなく、完全に別テンプレート

---

### 4. **PcClientManagerBundle** - 施設運営者向け管理画面

**役割**: 施設の担当者が自社施設情報を管理

```
PcClientManagerBundle/
├── Controller/
│   ├── FacilityController.php              # 施設情報編集
│   ├── FacilityBlogController.php          # ブログ投稿
│   ├── FacilityPhotoController.php         # 写真管理
│   ├── FacilityPlanController.php          # プラン管理
│   ├── InquireController.php               # 問い合わせ管理
│   ├── ReportController.php                # レポート閲覧
│   └── ...
├── Entity/                 # フォーム用Entity
│   ├── Facility.php
│   ├── FacilityBlog.php
│   └── ...
└── Form/                   # フォーム定義
    ├── FacilityType.php
    ├── FacilityBlogType.php
    └── ...
```

**主な機能**:
- 施設基本情報の編集
- ブログ記事の投稿・編集
- 写真・動画のアップロード
- 料金プランの設定
- 問い合わせ対応
- アクセスレポート閲覧

---

### 5. **PcManagerBundle** - 社内マネージャー向け管理画面

**役割**: LIFULL社内の営業担当者が施設情報を管理（簡易版）

```
PcManagerBundle/
├── Controller/
│   ├── FacilityTopController.php           # 施設一覧
│   ├── FacilityBasicfirstController.php    # 基本情報編集
│   ├── FacilityPhotoController.php         # 写真管理
│   ├── ReportController.php                # レポート
│   └── ...
└── Resources/
    └── views/              # マネージャー用テンプレート
```

**特徴**:
- PcClientManagerBundleの機能限定版
- 営業担当者が顧客の代わりに編集
- シンプルなUI

---

### 6. **PcAdminBundle** - システム管理者向け管理画面

**役割**: システム全体の管理・マスタデータ管理

```
PcAdminBundle/
├── Controller/
│   ├── ArticleContentController.php        # 記事CMS管理
│   ├── ArticleHierarchyController.php      # 記事階層管理
│   ├── CompanyController.php               # 会社マスタ
│   ├── FacilityEditController.php          # 施設マスタ
│   ├── PromotionController.php             # プロモーション設定
│   ├── ExportFacilityController.php        # データエクスポート
│   ├── ImportCsvController.php             # データインポート
│   ├── InterviewReportController.php       # 取材記事管理
│   ├── QaArticleController.php             # Q&A記事管理
│   └── ...
├── Services/
│   ├── exporter/           # エクスポート処理
│   ├── Importer/           # インポート処理
│   └── BusinessLogic/      # ビジネスロジック
└── Form/                   # 管理画面用フォーム
```

**主な機能**:
- 記事CMS（コンテンツ管理システム）
- 会社・施設マスタデータ管理
- プロモーション・広告設定
- データエクスポート/インポート
- 取材記事・Q&A記事管理
- システム設定

---

### 7. **AjaxBundle** - Ajax通信用API

**役割**: フロント画面からの非同期リクエスト処理

```
AjaxBundle/
├── Controller/
│   ├── DetailFacilityController.php        # 施設詳細関連
│   ├── FavoriteController.php              # お気に入り
│   ├── HistoryController.php               # 閲覧履歴
│   ├── ListFacilityController.php          # 施設一覧
│   ├── RankingFacilityController.php       # ランキング
│   ├── FacilityReviewController.php        # レビュー
│   └── ...
└── Services/
    └── MakeJson.php        # JSON生成
```

**主な機能**:
- お気に入り追加/削除
- 閲覧履歴取得
- ランキングデータ取得
- レビュー投稿
- 動的な施設一覧取得

**レスポンス例**:
```json
{
  "status": "success",
  "data": {
    "favoriteCount": 123,
    "isFavorite": true
  }
}
```

---

### 8. **ApiBundle** - 外部連携API

**役割**: 外部システムとの連携

```
ApiBundle/
├── Controller/
│   ├── ArticleController.php               # 記事配信API
│   └── FusionSmsController.php             # SMS送信連携
└── Resources/
    └── config/
        └── routing.yml     # APIルーティング
```

**主な機能**:
- 記事コンテンツの外部配信
- SMS送信サービス連携
- 外部システムへのデータ提供

---

### 9. **ConsoleBundle** - バッチ処理・コマンド

**役割**: 定期実行されるバッチ処理

```
ConsoleBundle/
├── Command/
│   ├── EsSyncSyncCommand.php               # Elasticsearch同期
│   ├── SitemapxmlCommand.php               # Sitemap生成
│   ├── InquireCallCommand.php              # 問い合わせ電話
│   ├── TrackMailSendCommand.php            # 追跡メール送信
│   ├── FacilityUpdateScheduleCommand.php   # 施設情報更新
│   ├── GaDataAcquisitionCommand.php        # GA データ取得
│   └── ...
├── BusinessLogic/          # バッチ用ビジネスロジック
└── Services/
    └── Batch/              # バッチ共通処理
```

**実行例**:
```bash
# Elasticsearch同期
php apps/kaigo_console/console es:sync

# Sitemap生成
php apps/kaigo_console/console sitemap:xml

# メール送信
php apps/kaigo_console/console track:mail:send
```

**主な機能**:
- Elasticsearchへのデータ同期
- Sitemap.xml生成
- メール一括送信
- レポート集計
- データ更新スケジュール実行

---

### 10. **ManagerBundle** - マネージャー共通機能

**役割**: PcManagerBundleとPcClientManagerBundleの共通ビジネスロジック

```
ManagerBundle/
├── Services/
│   └── BusinessLogic/      # 共通ビジネスロジック
└── Resources/
    └── views/              # 共通テンプレート
```

**特徴**:
- 重複コードの削減
- 管理画面共通の処理を集約

---

### 11. **RedirectFrontBundle** - リダイレクト処理

**役割**: URL変更時の自動リダイレクト

```
RedirectFrontBundle/
├── Listener/
│   └── RedirectionListener.php             # リダイレクト処理
└── Resources/
    └── config/
        └── redirections.yml                # リダイレクト設定
```

**設定例**:
```yaml
# redirections.yml
redirections:
  - from: /old-url
    to: /new-url
    status: 301
```

**特徴**:
- 旧URLから新URLへの自動転送
- SEO対策（301リダイレクト）
- リクエストごとに自動判定

---

## Bundle間の依存関係

```
┌─────────────────────────────────────────┐
│         プレゼンテーション層              │
│  PcFrontBundle / SpFrontBundle          │
│  PcAdminBundle / PcClientManagerBundle  │
│  AjaxBundle / ApiBundle                 │
└─────────────────────────────────────────┘
              ↓ 依存
┌─────────────────────────────────────────┐
│         アプリケーション層                │
│  FrontBundle / ManagerBundle            │
│  ConsoleBundle                          │
└─────────────────────────────────────────┘
              ↓ 依存
┌─────────────────────────────────────────┐
│         ドメイン層（基盤）                │
│  DomainBundle                           │
└─────────────────────────────────────────┘
              ↓ 依存
┌─────────────────────────────────────────┐
│         データ層                         │
│  PostgreSQL / Elasticsearch / Redis     │
└─────────────────────────────────────────┘
```

---

## Bundle設計の原則

### 1. 単一責任の原則
各Bundleは明確な責任を持つ
- FrontBundle: ユーザー向け画面
- PcAdminBundle: 管理者向け画面
- DomainBundle: ビジネスロジック

### 2. 依存関係の方向
上位層は下位層に依存するが、逆は禁止
- ✅ FrontBundle → DomainBundle
- ❌ DomainBundle → FrontBundle

### 3. 再利用性
共通機能はDomainBundleに集約
- Entity、Repository、Managerは全Bundleから利用可能

### 4. 疎結合
Bundle間は必要最小限の依存に留める
- サービスコンテナ経由で依存を注入

---

## 実際の処理フロー例

### 例: 施設詳細ページの表示

```
1. ユーザーがURLにアクセス
   https://kaigo.homes.co.jp/facility/12345/

2. Routing（apps/kaigo_pc_front/config/routing.yml）
   detail_facility.index → DetailFacilityController::indexAction

3. FrontBundle/Controller/DetailFacilityController
   - リクエストを受け取る
   - DomainBundleのManagerを呼び出し

4. DomainBundle/Component/Manager/FacilityManager
   - ビジネスロジック実行
   - Repositoryを呼び出し

5. DomainBundle/Component/Repository/FacilityRepository
   - データベースから施設情報を取得

6. FrontBundle/Services/Tdk/DetailFacility
   - SEO情報（Title/Description）を生成

7. PcFrontBundle/Resources/views/DetailFacility/index.html.twig
   - HTMLをレンダリング

8. ユーザーに画面を表示
```

---

## よくある質問

### Q1: 新しい機能を追加する時、どのBundleに書けばいい？

**A**: 機能の性質で判断
- ユーザー向け画面 → FrontBundle
- 管理画面 → PcAdminBundle / PcClientManagerBundle
- ビジネスロジック → DomainBundle
- バッチ処理 → ConsoleBundle

### Q2: DomainBundleとFrontBundleの違いは？

**A**: 
- **DomainBundle**: データとビジネスルール（再利用可能）
- **FrontBundle**: 画面表示とユーザー操作（特定の用途）

### Q3: なぜBundleを分けるの？

**A**: 
- コードの整理と保守性向上
- 機能ごとの独立性確保
- チーム開発での役割分担
- テストのしやすさ

### Q4: 既存のBundleを修正する時の注意点は？

**A**:
- DomainBundleの変更は全体に影響するため慎重に
- 他のBundleから参照されていないか確認
- テストを必ず実行

---

## まとめ

| Bundle | 役割 | 主な利用者 |
|--------|------|-----------|
| DomainBundle | ビジネスロジック・データモデル | 全Bundle |
| FrontBundle | ユーザー向け画面処理 | 一般ユーザー |
| PcFrontBundle/SpFrontBundle | デバイス別テンプレート | 一般ユーザー |
| PcClientManagerBundle | 施設運営者向け管理画面 | 施設担当者 |
| PcManagerBundle | 社内マネージャー向け管理画面 | LIFULL営業 |
| PcAdminBundle | システム管理画面 | システム管理者 |
| AjaxBundle | Ajax API | フロント画面 |
| ApiBundle | 外部連携API | 外部システム |
| ConsoleBundle | バッチ処理 | Cronジョブ |
| ManagerBundle | 管理画面共通機能 | 管理画面系Bundle |
| RedirectFrontBundle | リダイレクト処理 | 全アプリ |

このように、Bundleは「誰が使うか」「何をするか」で分割されており、コードの保守性と再利用性を高めています。
